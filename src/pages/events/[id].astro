---
import BaseLayout from "../../layouts/BaseLayout.astro";
import JsonLd from "../../components/JsonLd.astro";
import { buildOrganization, buildPlace, buildEvent } from "../../lib/schema";

/**
 * ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆã“ã‚Œã¾ã§ã®ä¸€è¦§ã¨IDã‚’åˆã‚ã›ã¦ã„ã¾ã™ï¼‰
 * å®Ÿãƒ‡ãƒ¼ã‚¿æ¥ç¶šæ™‚ã¯ API/DB ã‹ã‚‰å–å¾—ã—ã€getStaticPaths ã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚
 */
const allEvents = [
  {
    id: "ev-001",
    title: "æœæ´»ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ï¼ æœ¨å ´å…¬åœ’",
    description: "åˆå¿ƒè€…æ­“è¿ã€‚ä¼šè©±ã—ãªãŒã‚‰è»½ã3kmï¼ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—â†’ã‚†ã‚‹ãƒ©ãƒ³â†’ã‚¹ãƒˆãƒ¬ãƒƒãƒã®æµã‚Œã§ã™ã€‚",
    image: "/og.png",
    dateText: "2025-09-01 07:00",
    endText:  "2025-09-01 08:00",
    placeText: "æœ¨å ´å…¬åœ’é›†åˆ",
    areaText: "æ±Ÿæ±åŒº",
    isFeatured: true,
    fee: 0,
    capacity: 20,
    organizer: "MinnaCircle Running",
    createdAt: "2025-08-10T08:00:00+09:00",
    tags: ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°","åˆå¿ƒè€…æ­“è¿","æœæ´»"]
  },
  {
    id: "ev-002",
    title: "é€±æœ«ãƒã‚¹ã‚±å€‹äººå‚åŠ ",
    description: "çµŒé¨“ä¸å•ã€‚ãƒãƒ¼ãƒ åˆ†ã‘â†’ã‚¹ã‚¯ãƒªãƒ¡ãƒ¼ã‚¸ä¸­å¿ƒã€‚æ€ªæˆ‘é˜²æ­¢ã®ãŸã‚æº–å‚™é‹å‹•ã‚’å„è‡ªã§ãŠé¡˜ã„ã—ã¾ã™ã€‚",
    image: "/og.png",
    dateText: "2025-09-06 18:00",
    endText:  "2025-09-06 20:00",
    placeText: "æ±Ÿæ±åŒºã‚¹ãƒã‚»ãƒ³",
    areaText: "æ±Ÿæ±åŒº",
    isFeatured: false,
    fee: 800,
    capacity: 30,
    organizer: "MinnaCircle Basketball",
    createdAt: "2025-08-14T18:00:00+09:00",
    tags: ["ãƒã‚¹ã‚±","å€‹ã‚µãƒ«","åˆå¿ƒè€…æ­“è¿"]
  },
  {
    id: "ev-003",
    title: "è‹±ä¼šè©±ã‚†ã‚‹ã‚«ãƒ•ã‚§ä¼š",
    description: "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«è‹±ä¼šè©±ã€‚ãƒ¬ãƒ™ãƒ«ä¸å•ã€‚å­é€£ã‚Œå¯ã€‚ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯ã®ãƒ†ãƒ¼ãƒã‚«ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚",
    image: "/og.png",
    dateText: "2025-09-07 10:00",
    endText:  "2025-09-07 11:30",
    placeText: "æ¸…æ¾„ç™½æ²³",
    areaText: "æ±Ÿæ±åŒº",
    isFeatured: false,
    fee: 500,
    capacity: 12,
    organizer: "MinnaCircle English",
    createdAt: "2025-08-12T12:00:00+09:00",
    tags: ["è‹±ä¼šè©±","ã‚«ãƒ•ã‚§","è¦ªå­OK"]
  }
];

/** å‹•çš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ */
const { id } = Astro.params;

/** æœ¬æ¥ã¯API/DBã‹ã‚‰è©²å½“IDã‚’å–å¾— */
const event = allEvents.find((e) => e.id === id);
if (!event) {
  throw Astro.redirect("/404");
}

/** ãƒ¡ã‚¿ */
const pageTitle = `${event.title} | MinnaCircle`;
const pageDesc  = `${event.description}`;

/** ã‚µã‚¤ãƒˆOriginï¼ˆastro.configã®siteãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«ä½¿ç”¨ï¼‰ */
const siteOrigin = (Astro.site && Astro.site.href) ? Astro.site.href.replace(/\/$/, "") : "";

/** "YYYY-MM-DD HH:mm" â†’ "YYYY-MM-DDTHH:mm:00+09:00"ï¼ˆæ—¥æœ¬æ™‚é–“ã®ã¾ã¾å‡ºåŠ›ï¼‰ */
const toJstOffset = (s: string) => {
  const [date, hm] = s.split(" ");
  return `${date}T${hm}:00+09:00`;
};

/** Organizer / Place / Event ã® JSON-LDï¼ˆschema.ts ã‚’ä½¿ç”¨ï¼‰ */
const organizer = buildOrganization({
  name: event.organizer,
  url: siteOrigin || undefined,
});

const place = buildPlace({
  name: event.placeText,
  addressLocality: event.areaText,
  addressCountry: "JP",
  // latitude / longitude ã¯å®Ÿãƒ‡ãƒ¼ã‚¿æ¥ç¶šæ™‚ã«è¿½åŠ 
});

// ç”»åƒãƒ»URLã¯çµ¶å¯¾URLæ¨å¥¨
const absoluteImage = siteOrigin ? `${siteOrigin}${event.image}` : event.image;
const detailUrl = siteOrigin ? `${siteOrigin}/events/${event.id}` : undefined;

const schemaEvent = {
  ...buildEvent({
    name: event.title,
    description: event.description,
    startDate: toJstOffset(event.dateText),
    endDate: event.endText ? toJstOffset(event.endText) : undefined,
    location: place,
    organizer,
    image: [absoluteImage],
    offers: Number.isFinite(event.fee)
      ? { price: String(event.fee), priceCurrency: "JPY", url: siteOrigin ? `${siteOrigin}/events/${event.id}/join` : undefined, availability: "InStock" }
      : undefined,
  }),
  ...(detailUrl ? { url: detailUrl } : {}), // Event.url ã‚’ä»˜ä¸
};

/** JSON-LD: ãƒ‘ãƒ³ããš */
const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", ...(siteOrigin ? { "item": siteOrigin } : {}) },
    { "@type": "ListItem", "position": 2, "name": "Events", ...(siteOrigin ? { "item": `${siteOrigin}/events` } : {}) },
    { "@type": "ListItem", "position": 3, "name": event.title, ...(siteOrigin ? { "item": `${siteOrigin}/events/${event.id}` } : {}) }
  ]
};
---

<BaseLayout title={pageTitle} lang="ja" description={pageDesc}>
  <!-- JSON-LD: Event / Breadcrumb -->
  <JsonLd data={[schemaEvent, breadcrumbLd]} />

  <section class="max-w-5xl mx-auto px-4 py-8 md:py-12">
    <!-- ã‚¿ã‚¤ãƒˆãƒ« / ãƒ¡ã‚¿ -->
    <div class="mb-6">
      <nav class="text-xs text-gray-500 mb-2">
        <a class="hover:underline" href="/">Home</a> / <a class="hover:underline" href="/events">Events</a> / <span>{event.title}</span>
      </nav>
      <h1 class="text-2xl md:text-4xl font-extrabold">{event.title}</h1>
      <div class="mt-2 flex flex-wrap gap-2 text-sm text-gray-600">
        <span>ğŸ“… {event.dateText}{event.endText ? ` ã€œ ${event.endText}` : ""}</span>
        <span>ãƒ»ğŸ“ {event.placeText}ï¼ˆ{event.areaText}ï¼‰</span>
        {Number.isFinite(event.fee) && (<span>ãƒ»ğŸ’´ å‚åŠ è²»: {event.fee === 0 ? "ç„¡æ–™" : `Â¥${event.fee.toLocaleString()}`}</span>)}
        {event.capacity && (<span>ãƒ»ğŸ‘¥ å®šå“¡: {event.capacity}å</span>)}
      </div>
      <div class="mt-2 flex flex-wrap gap-2">
        {event.tags?.map((t) => <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs">{t}</span>)}
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <div class="grid grid-cols-1 md:grid-cols-[2fr_1fr] gap-6">
      <!-- è©³ç´° -->
      <article class="bg-white rounded-2xl shadow p-5 md:p-7">
        <img src={event.image} alt={event.title} class="rounded-xl w-full h-56 object-cover mb-4" loading="lazy" />
        <h2 class="text-lg md:text-xl font-bold mb-2">ã‚¤ãƒ™ãƒ³ãƒˆæ¦‚è¦</h2>
        <p class="text-gray-700 leading-relaxed">{event.description}</p>

        <h3 class="mt-6 font-semibold">é–‹å‚¬æƒ…å ±</h3>
        <ul class="mt-2 text-sm text-gray-700 space-y-1">
          <li>ğŸ“… é–‹å‚¬æ—¥æ™‚: {event.dateText}{event.endText ? ` ã€œ ${event.endText}` : ""}</li>
          <li>ğŸ“ ä¼šå ´: {event.placeText}ï¼ˆ{event.areaText}ï¼‰</li>
          {Number.isFinite(event.fee) && (<li>ğŸ’´ å‚åŠ è²»: {event.fee === 0 ? "ç„¡æ–™" : `Â¥${event.fee.toLocaleString()}`}</li>)}
          {event.capacity && (<li>ğŸ‘¥ å®šå“¡: {event.capacity}å</li>)}
          <li>ğŸ·ï¸ ã‚¿ã‚°: {event.tags?.join(" / ")}</li>
          <li>ğŸ§‘â€ğŸ¤â€ğŸ§‘ ä¸»å‚¬: {event.organizer}</li>
        </ul>

        <div class="mt-6 flex gap-3">
          <a href={`/events/${event.id}/join`} class="bg-indigo-600 text-white px-5 py-2 rounded-xl shadow hover:bg-indigo-700 transition">å‚åŠ ç”³ã—è¾¼ã¿ã¸</a>
          <a href="/search?type=event" class="px-5 py-2 rounded-xl border hover:bg-gray-50 transition">ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™</a>
        </div>
      </article>

      <!-- ã‚µã‚¤ãƒ‰ -->
      <aside class="space-y-4">
        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="font-semibold mb-2">é–‹å‚¬åœ°</h3>
          <p class="text-sm text-gray-700">{event.placeText}ï¼ˆ{event.areaText}ï¼‰</p>
          <p class="text-xs text-gray-500 mt-1">â€»ä½æ‰€è©³ç´°ã‚„åœ°å›³ã¯ä¸»å‚¬è€…ãŒå…¬é–‹ç¯„å›²ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
        </div>

        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="font-semibold mb-2">æ³¨æ„äº‹é …</h3>
          <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
            <li>ä½“èª¿ä¸è‰¯æ™‚ã¯ç„¡ç†ã›ãšå‚åŠ ã‚’ãŠæ§ãˆãã ã•ã„ã€‚</li>
            <li>æœªæˆå¹´ã®æ–¹ã¯ä¿è­·è€…ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚</li>
            <li>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã®ä¸Šé™ã¯å‚åŠ è²»100%ã§ã™ã€‚</li>
          </ul>
        </div>

        <a href="/" class="block text-center text-indigo-700 underline">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
      </aside>
    </div>
  </section>
</BaseLayout>

