---
import BaseLayout from "../../layouts/BaseLayout.astro";
import JsonLd from "../../components/JsonLd.astro";
import { buildOrganization } from "../../lib/schema";

/**
 * ダミーのサークル一覧（トップの featuredCircles とID合わせ）
 * 実運用では API/DB に差し替え、getStaticPaths で動的生成してください。
 */
const allCircles = [
  {
    id: "cl-001",
    name: "ミンナでバスケ",
    intro: "初心者～経験者まで幅広く。試合より交流重視！",
    image: "/og.png",
    memberCount: 42,
    areaText: "江東区・墨田区",
    tags: ["バスケ","交流","初心者OK"],
    social: { x: "", instagram: "" }
  },
  {
    id: "cl-002",
    name: "清澄コーヒー巡り部",
    intro: "週一でコーヒー店を探訪。豆知識交換しましょう。",
    image: "/og.png",
    memberCount: 18,
    areaText: "清澄白河・門前仲町",
    tags: ["カフェ","コーヒー","街歩き"],
    social: { x: "", instagram: "" }
  },
  {
    id: "cl-003",
    name: "親子で外遊び",
    intro: "小さなお子さん歓迎。水遊び・公園ピクニックなど。",
    image: "/og.png",
    memberCount: 27,
    areaText: "東陽町・有明",
    tags: ["親子","外遊び","ピクニック"],
    social: { x: "", instagram: "" }
  }
];

/** ルーティングパラメータ */
const { id } = Astro.params;

/** 対象サークルを取得（なければ404） */
const circle = allCircles.find((c) => c.id === id);
if (!circle) {
  throw Astro.redirect("/404");
}

/** メタ */
const pageTitle = `${circle.name} | MinnaCircle`;
const pageDesc  = circle.intro;

/** サイトOrigin（astro.configのsiteがあれば使用） */
const siteOrigin = (Astro.site && Astro.site.href) ? Astro.site.href.replace(/\/$/, "") : "";

/** JSON-LD: Organization（サークル自体を団体としてマークアップ） */
const orgLd = buildOrganization({
  name: circle.name,
  url: siteOrigin ? `${siteOrigin}/circles/${circle.id}` : undefined,
  logo: siteOrigin ? `${siteOrigin}${circle.image}` : undefined,
  sameAs: [circle.social?.x, circle.social?.instagram].filter(Boolean)
});

/** JSON-LD: パンくず */
const breadcrumbLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      ...(siteOrigin ? { "item": siteOrigin } : {})
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Circles",
      ...(siteOrigin ? { "item": `${siteOrigin}/circles` } : {})
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": circle.name,
      ...(siteOrigin ? { "item": `${siteOrigin}/circles/${circle.id}` } : {})
    }
  ]
};
---

<BaseLayout title={pageTitle} lang="ja" description={pageDesc}>
  <!-- JSON-LD: Organization / Breadcrumb -->
  <JsonLd data={[orgLd, breadcrumbLd]} />

  <section class="max-w-5xl mx-auto px-4 py-8 md:py-12">
    <!-- パンくず / タイトル -->
    <div class="mb-6">
      <nav class="text-xs text-gray-500 mb-2">
        <a class="hover:underline" href="/">Home</a> / <a class="hover:underline" href="/circles">Circles</a> / <span>{circle.name}</span>
      </nav>
      <h1 class="text-2xl md:text-4xl font-extrabold">{circle.name}</h1>
      <div class="mt-2 text-sm text-gray-600 space-y-1">
        <div>🧭 活動エリア: {circle.areaText}</div>
        <div>👥 メンバー数: {circle.memberCount}人</div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2">
        {circle.tags?.map((t) => <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs">{t}</span>)}
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[2fr_1fr] gap-6">
      <!-- メイン -->
      <article class="bg-white rounded-2xl shadow p-5 md:p-7">
        <img src={circle.image} alt={circle.name} class="rounded-xl w-full h-56 object-cover mb-4" loading="lazy" />
        <h2 class="text-lg md:text-xl font-bold mb-2">サークル紹介</h2>
        <p class="text-gray-700 leading-relaxed">{circle.intro}</p>

        <h3 class="mt-6 font-semibold">活動情報</h3>
        <ul class="mt-2 text-sm text-gray-700 space-y-1">
          <li>🗺️ 主なエリア: {circle.areaText}</li>
          <li>👥 メンバー数: {circle.memberCount}人</li>
          <li>🏷️ タグ: {circle.tags?.join(" / ")}</li>
        </ul>

        <div class="mt-6 flex gap-3">
          <a href={`/search?type=event&q=${encodeURIComponent(circle.name)}`} class="px-5 py-2 rounded-xl border hover:bg-gray-50 transition">このサークルのイベントを探す</a>
          <a href="/vendor/new" class="bg-indigo-600 text-white px-5 py-2 rounded-xl shadow hover:bg-indigo-700 transition">サークルに問い合わせ</a>
        </div>
      </article>

      <!-- サイド -->
      <aside class="space-y-4">
        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="font-semibold mb-2">リンク</h3>
          <ul class="text-sm text-indigo-700 space-y-1">
            <li><a class="hover:underline" href="/events">イベント一覧</a></li>
            <li><a class="hover:underline" href="/places">開催場所一覧</a></li>
          </ul>
          {circle.social?.x && (<p class="text-xs text-gray-500 mt-2">X: <a class="text-indigo-700 hover:underline" href={circle.social.x}>{circle.social.x}</a></p>)}
          {circle.social?.instagram && (<p class="text-xs text-gray-500">Instagram: <a class="text-indigo-700 hover:underline" href={circle.social.instagram}>{circle.social.instagram}</a></p>)}
        </div>

        <a href="/circles" class="block text-center text-indigo-700 underline">サークル一覧へ戻る</a>
      </aside>
    </div>
  </section>
</BaseLayout>

